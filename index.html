<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Diário de Enxaqueca</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    label {
      display: flex;
      flex-direction: column;
    }
    input, select, textarea, button {
      padding: 8px;
      font-size: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f4f4f4;
    }
    #exportBtn {
      margin-top: 10px;
      padding: 10px;
      background-color: #3e8e41;
      color: white;
      border: none;
      cursor: pointer;
    }
    canvas {
      max-width: 100%;
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h1>Diário de Enxaqueca</h1>

  <form id="migraineForm">
    <label>Data:
      <input type="date" id="data" required />
    </label>
    <label>Turno:
      <select id="turno" required>
        <option value="" disabled selected>Selecione o turno</option>
        <option value="Manhã">Manhã</option>
        <option value="Tarde">Tarde</option>
        <option value="Noite">Noite</option>
      </select>
    </label>
    <label>Intensidade (0-10):
      <input type="number" id="intensidade" min="0" max="10" required />
    </label>
    <label>Quantidade de Naratriptano (comprimidos):
      <input type="number" id="naratriptano" min="0" value="0" required />
    </label>
    <label>Quantidade de Nimesulida (comprimidos):
      <input type="number" id="nimesulida" min="0" value="0" required />
    </label>
    <label>Usava óculos na hora?
      <select id="oculos">
        <option value="Sim">Sim</option>
        <option value="Não">Não</option>
      </select>
    </label>
    <label>Problemas visuais?
      <input type="text" id="visao" placeholder="Ex: visão turva, pontos, aura" />
    </label>
    <label>Observações:
      <textarea id="obs" rows="3"></textarea>
    </label>
    <button type="submit">Salvar</button>
  </form>

  <h2>Crises Registradas</h2>
  <table id="tabelaCrises">
    <thead>
      <tr>
        <th>Data</th>
        <th>Turno</th>
        <th>Intensidade</th>
        <th>Naratriptano</th>
        <th>Nimesulida</th>
        <th>Óculos</th>
        <th>Visão</th>
        <th>Observações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="exportBtn">Exportar para CSV</button>

  <h2>Frequência Diária</h2>
  <canvas id="graficoCrises"></canvas>

  <script>
    const form = document.getElementById('migraineForm');
    const tabela = document.querySelector('#tabelaCrises tbody');
    const exportBtn = document.getElementById('exportBtn');
    const graficoCanvas = document.getElementById('graficoCrises');
    let grafico;

    function salvarNoLocalStorage(data) {
      const crises = JSON.parse(localStorage.getItem('crises')) || [];
      crises.push(data);
      localStorage.setItem('crises', JSON.stringify(crises));
    }

    function carregarCrises() {
      const crises = JSON.parse(localStorage.getItem('crises')) || [];
      tabela.innerHTML = '';
      crises.forEach(c => {
        const row = tabela.insertRow();
        row.innerHTML = `
          <td>${c.data}</td>
          <td>${c.turno}</td>
          <td>${c.intensidade}</td>
          <td>${c.naratriptano}</td>
          <td>${c.nimesulida}</td>
          <td>${c.oculos}</td>
          <td>${c.visao}</td>
          <td>${c.obs}</td>
        `;
      });
      desenharGrafico(crises);
    }

    function exportarCSV() {
      const crises = JSON.parse(localStorage.getItem('crises')) || [];
      let csv = 'Data,Turno,Intensidade,Naratriptano,Nimesulida,Óculos,Visão,Observações\n';
      crises.forEach(c => {
        csv += `${c.data},${c.turno},${c.intensidade},${c.naratriptano},${c.nimesulida},${c.oculos},"${c.visao}","${c.obs}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "diario_enxaqueca.csv");
      link.click();
    }

    function desenharGrafico(crises) {
      // Contar crises por dia (data)
      const contagemDiaria = {};
      crises.forEach(c => {
        // Para garantir formato yyyy-mm-dd
        contagemDiaria[c.data] = (contagemDiaria[c.data] || 0) + 1;
      });

      // Ordenar datas
      const labels = Object.keys(contagemDiaria).sort((a,b) => new Date(a) - new Date(b));
      const dados = labels.map(label => contagemDiaria[label]);

      if (grafico) grafico.destroy();
      grafico = new Chart(graficoCanvas, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Crises por Dia',
            data: dados,
            backgroundColor: '#ff6384'
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
              stepSize: 1,
              ticks: {
                precision:0
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.parsed.y} crise(s)`
              }
            }
          }
        }
      });
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const data = {
        data: document.getElementById('data').value,
        turno: document.getElementById('turno').value,
        intensidade: document.getElementById('intensidade').value,
        naratriptano: document.getElementById('naratriptano').value,
        nimesulida: document.getElementById('nimesulida').value,
        oculos: document.getElementById('oculos').value,
        visao: document.getElementById('visao').value,
        obs: document.getElementById('obs').value
      };
      salvarNoLocalStorage(data);
      carregarCrises();
      form.reset();
      document.getElementById('turno').selectedIndex = 0; // reset select placeholder
    });

    carregarCrises();
  </script>
</body>
</html>
